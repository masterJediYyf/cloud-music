{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\86136\\\\Desktop\\\\\\u5B66\\u4E60\\u8FDB\\u5EA6\\\\new_html\\\\fullstack_yyf\\\\react\\\\cloud-music\\\\src\\\\application\\\\Player\\\\index.js\",\n    _s = $RefreshSig$();\n\nimport React, { useRef, useState, useEffect } from \"react\";\nimport { connect } from 'react-redux';\nimport MiniPlayer from './miniPlayer';\nimport NormalPlayer from './normalPlayer';\nimport { getSongUrl, isEmptyObject, shuffle, findIndex } from '../../api/utils';\nimport { changePlayingState, changeShowPlayList, changeCurrentIndex, changeCurrentSong, changePlayList, changePlayMode, changeFullScreen } from './store/actionCreators';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nfunction Player(props) {\n  _s();\n\n  // 目前播放时间\n  const [currentTime, setCurrentTime] = useState(0); // 歌曲总时长\n\n  const [duration, setDuration] = useState(0); //记录当前的歌曲 以便于下次重渲染时比对是否是一首歌\n\n  const [preSong, setPreSong] = useState({}); // mock 一份currentIndex\n\n  useEffect(() => {\n    changeCurrentIndexDispatch(0);\n  }, []); //歌曲播放进度\n\n  let percent = isNaN(currentTime / duration) ? 0 : currentTime / duration; //从props中取redux数据和dispatch方法\n\n  const {\n    playing,\n    currentSong: immutableCurrentSong,\n    currentIndex,\n    playList: immutablePlayList,\n    mode,\n    //播放模式\n    sequencePlayList: immutableSequencePlayList,\n    //顺序列表\n    fullScreen\n  } = props;\n  const {\n    togglePlayingDispatch,\n    changeCurrentIndexDispatch,\n    changeCurrentDispatch,\n    changePlayListDispatch,\n    //改变playList\n    changeModeDispatch,\n    //改变mode\n    toggleFullScreenDispatch\n  } = props;\n  const playList = immutablePlayList.toJS();\n  const sequencePlayList = immutableSequencePlayList.toJS();\n  const currentSong = immutableCurrentSong.toJS();\n  const audioRef = useRef();\n\n  const clickPlaying = (e, state) => {\n    e.stopPropagation();\n    togglePlayingDispatch(state);\n  }; //Player/index\n\n\n  const changeMode = () => {\n    let newMode = (mode + 1) % 3;\n\n    if (newMode === 0) {\n      //顺序模式\n      changePlayListDispatch(sequencePlayList);\n      let index = findIndex(currentSong, sequencePlayList);\n      changeCurrentIndexDispatch(index);\n    } else if (newMode === 1) {\n      //单曲循环\n      changePlayListDispatch(sequencePlayList);\n    } else if (newMode === 2) {\n      //随机播放\n      let newList = shuffle(sequencePlayList);\n      let index = findIndex(currentSong, newList);\n      changePlayListDispatch(newList);\n      changeCurrentIndexDispatch(index);\n    }\n\n    changeModeDispatch(newMode);\n  };\n\n  useEffect(() => {\n    if (!currentSong) return;\n    changeCurrentIndexDispatch(0); //currentIndex 默认未 -1,临时改成0\n\n    let current = playList[0];\n    changeCurrentDispatch(current); //赋值 currentSong\n\n    audioRef.current.src = getSongUrl(current.id);\n    setTimeout(() => {\n      audioRef.current.play();\n    });\n    togglePlayingDispatch(true); //播放状态\n\n    setCurrentTime(0); //从头开始播放\n\n    setDuration(current.dt / 1000 | 0); //时长\n  }, []);\n  useEffect(() => {\n    playing ? audioRef.current.play() : audioRef.current.pause();\n  }, [playing]);\n  useEffect(() => {\n    if (!playList.length || currentIndex === -1 || !playList[currentIndex] || playList[currentIndex].id === preSong.id || !songReady) return;\n    let current = playList[currentIndex];\n    setPreSong(current);\n    setSongReady(false);\n    changeCurrentDispatch(current); //赋值currentSong\n\n    audioRef.current.src = getSongUrl(current.id);\n    setTimeout(() => {\n      audioRef.current.play().then(() => {\n        setSongReady(true);\n      });\n    });\n    togglePlayingDispatch(true); //播放状态\n\n    setCurrentTime(0); //从头开始播放\n\n    setDuration(current.dt / 1000 | 0); //时长\n  }, [playList, currentIndex]);\n\n  const updateTime = e => {\n    setCurrentTime(e.target.currentTime);\n  };\n\n  const onProgressChange = curPercent => {\n    const newTime = curPercent * duration;\n    setCurrentTime(newTime);\n    audioRef.current.currentTime = newTime;\n\n    if (!playing) {\n      togglePlayingDispatch(true);\n    }\n  }; // 一首歌循环\n\n\n  const handleLoop = () => {\n    audioRef.current.currentTime = 0;\n    changePlayingState(true);\n    audioRef.current.play();\n  }; // 播放上一首\n\n\n  const handlePrev = () => {\n    //播放列表只有一首歌的时单曲循环\n    if (playList.length === 1) {\n      handleLoop();\n      return;\n    }\n\n    let index = currentIndex - 1;\n    if (index < 0) index = playList.length - 1; // 队尾变队头\n\n    if (!playing) togglePlayingDispatch(true);\n    changeCurrentIndexDispatch(index);\n  }; // 播放下一首\n\n\n  const handleNext = () => {\n    // 播放列表只有一首歌时单曲循环\n    if (playList.length === 1) {\n      handleLoop();\n      return;\n    }\n\n    let index = currentIndex + 1;\n    if (index === playList.length) index = 0;\n    if (!playing) togglePlayingDispatch(true);\n    changeCurrentIndexDispatch(index);\n  };\n\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    children: [isEmptyObject(currentSong) ? null : /*#__PURE__*/_jsxDEV(MiniPlayer, {\n      song: currentSong,\n      fullScreen: fullScreen,\n      playing: playing,\n      toggleFullScreen: toggleFullScreenDispatch,\n      clickPlaying: clickPlaying,\n      percent: percent\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 179,\n      columnNumber: 11\n    }, this), isEmptyObject(currentSong) ? null : /*#__PURE__*/_jsxDEV(NormalPlayer, {\n      song: currentSong,\n      fullScreen: fullScreen,\n      playing: playing,\n      duration: duration //总时长\n      ,\n      currentTime: currentTime //播放时长\n      ,\n      percent: percent //进度\n      ,\n      toggleFullScreen: toggleFullScreenDispatch,\n      clickPlaying: clickPlaying,\n      onProgressChange: onProgressChange,\n      handlePrev: handlePrev,\n      handleNext: handleNext\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 189,\n      columnNumber: 11\n    }, this), /*#__PURE__*/_jsxDEV(\"audio\", {\n      ref: audioRef,\n      onTimeUpdate: updateTime\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 203,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 177,\n    columnNumber: 9\n  }, this);\n} //映射 Redux 全局的 state 到组件的 props 上\n\n\n_s(Player, \"NtDqPZws+j/Y8tpGMa/zYB57duU=\");\n\n_c = Player;\n\nconst mapStateToProps = state => ({\n  fullScreen: state.getIn([\"player\", \"fullScreen\"]),\n  playing: state.getIn([\"player\", \"playing\"]),\n  currentSong: state.getIn([\"player\", \"currentSong\"]),\n  showPlayList: state.getIn([\"player\", \"showPlayList\"]),\n  mode: state.getIn([\"player\", \"mode\"]),\n  currentIndex: state.getIn([\"player\", \"currentIndex\"]),\n  playList: state.getIn([\"player\", \"playList\"]),\n  sequencePlayList: state.getIn([\"player\", \"sequencePlayList\"])\n}); //映射 dispatch 到 props 上\n\n\nconst mapDispatchToProps = dispatch => {\n  return {\n    togglePlayingDispatch(data) {\n      dispatch(changePlayingState(data));\n    },\n\n    toggleFullScreenDispatch(data) {\n      dispatch(changeFullScreen(data));\n    },\n\n    togglePlayListDispatch(data) {\n      dispatch(changeShowPlayList(data));\n    },\n\n    changeCurrentIndexDispatch(index) {\n      dispatch(changeCurrentIndex(index));\n    },\n\n    changeCurrentDispatch(data) {\n      dispatch(changeCurrentSong(data));\n    },\n\n    changeModeDispatch(data) {\n      dispatch(changePlayMode(data));\n    },\n\n    changePlayListDispatch(data) {\n      dispatch(changePlayList(data));\n    }\n\n  };\n}; // 将ui 组件 包装成容器组件\n\n\nexport default connect(mapStateToProps, mapDispatchToProps)( /*#__PURE__*/React.memo(Player));\n\nvar _c;\n\n$RefreshReg$(_c, \"Player\");","map":{"version":3,"sources":["C:/Users/86136/Desktop/学习进度/new_html/fullstack_yyf/react/cloud-music/src/application/Player/index.js"],"names":["React","useRef","useState","useEffect","connect","MiniPlayer","NormalPlayer","getSongUrl","isEmptyObject","shuffle","findIndex","changePlayingState","changeShowPlayList","changeCurrentIndex","changeCurrentSong","changePlayList","changePlayMode","changeFullScreen","Player","props","currentTime","setCurrentTime","duration","setDuration","preSong","setPreSong","changeCurrentIndexDispatch","percent","isNaN","playing","currentSong","immutableCurrentSong","currentIndex","playList","immutablePlayList","mode","sequencePlayList","immutableSequencePlayList","fullScreen","togglePlayingDispatch","changeCurrentDispatch","changePlayListDispatch","changeModeDispatch","toggleFullScreenDispatch","toJS","audioRef","clickPlaying","e","state","stopPropagation","changeMode","newMode","index","newList","current","src","id","setTimeout","play","dt","pause","length","songReady","setSongReady","then","updateTime","target","onProgressChange","curPercent","newTime","handleLoop","handlePrev","handleNext","mapStateToProps","getIn","showPlayList","mapDispatchToProps","dispatch","data","togglePlayListDispatch","memo"],"mappings":"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","sourcesContent":["import React,{useRef,useState,useEffect} from \"react\";\r\nimport { connect } from 'react-redux';\r\nimport MiniPlayer from './miniPlayer';\r\nimport NormalPlayer from './normalPlayer';\r\nimport { getSongUrl,isEmptyObject, shuffle, findIndex } from '../../api/utils';\r\n\r\nimport {\r\n    changePlayingState,\r\n    changeShowPlayList,\r\n    changeCurrentIndex,\r\n    changeCurrentSong,\r\n    changePlayList,\r\n    changePlayMode,\r\n    changeFullScreen\r\n} from './store/actionCreators';\r\n\r\nfunction Player(props){\r\n\r\n    // 目前播放时间\r\n    const [currentTime, setCurrentTime] = useState(0);\r\n\r\n    // 歌曲总时长\r\n    const [duration, setDuration] = useState(0);\r\n\r\n    //记录当前的歌曲 以便于下次重渲染时比对是否是一首歌\r\n    const [preSong, setPreSong] = useState({});\r\n\r\n    // mock 一份currentIndex\r\n    useEffect(() => {\r\n      changeCurrentIndexDispatch(0);\r\n    },[]);\r\n\r\n    \r\n    //歌曲播放进度\r\n    let percent = isNaN(currentTime / duration) ? 0 : currentTime / duration;\r\n\r\n    //从props中取redux数据和dispatch方法\r\n    const {\r\n      playing,\r\n      currentSong:immutableCurrentSong,\r\n      currentIndex,\r\n      playList:immutablePlayList,\r\n      mode,//播放模式\r\n      sequencePlayList:immutableSequencePlayList,//顺序列表\r\n      fullScreen\r\n    } = props;\r\n\r\n    const {\r\n      togglePlayingDispatch,\r\n      changeCurrentIndexDispatch,\r\n      changeCurrentDispatch,\r\n      changePlayListDispatch,//改变playList\r\n      changeModeDispatch,//改变mode\r\n      toggleFullScreenDispatch\r\n    } = props;\r\n\r\n    const playList = immutablePlayList.toJS();\r\n    const sequencePlayList = immutableSequencePlayList.toJS();\r\n    const currentSong = immutableCurrentSong.toJS();\r\n\r\n    const audioRef = useRef();\r\n\r\n    const clickPlaying = (e, state) => {\r\n      e.stopPropagation();\r\n      togglePlayingDispatch(state);\r\n    };\r\n\r\n    //Player/index\r\n    const changeMode = () => {\r\n      let newMode = (mode + 1) % 3;\r\n      if (newMode === 0) {\r\n        //顺序模式\r\n        changePlayListDispatch(sequencePlayList);\r\n        let index = findIndex(currentSong, sequencePlayList);\r\n        changeCurrentIndexDispatch(index);\r\n      } else if (newMode === 1) {\r\n        //单曲循环\r\n        changePlayListDispatch(sequencePlayList);\r\n      } else if (newMode === 2) {\r\n        //随机播放\r\n        let newList = shuffle(sequencePlayList);\r\n        let index = findIndex(currentSong, newList);\r\n        changePlayListDispatch(newList);\r\n        changeCurrentIndexDispatch(index);\r\n      }\r\n      changeModeDispatch(newMode);\r\n    };\r\n\r\n    useEffect(() => {\r\n      if(!currentSong) return;\r\n      changeCurrentIndexDispatch(0);//currentIndex 默认未 -1,临时改成0\r\n      let current = playList[0];\r\n      changeCurrentDispatch(current);//赋值 currentSong\r\n      audioRef.current.src = getSongUrl(current.id);\r\n      setTimeout(() => {\r\n        audioRef.current.play();\r\n      });\r\n      togglePlayingDispatch(true); //播放状态\r\n      setCurrentTime(0); //从头开始播放\r\n      setDuration((current.dt / 1000) | 0); //时长\r\n    },[])\r\n\r\n    useEffect(() => {\r\n      playing ? audioRef.current.play() : audioRef.current.pause();\r\n    }, [playing]);\r\n\r\n    useEffect(() => {\r\n      if (\r\n        !playList.length ||\r\n        currentIndex === -1 ||\r\n        !playList[currentIndex] ||\r\n        playList[currentIndex].id === preSong.id ||\r\n        !songReady\r\n      )\r\n        return;\r\n      let current = playList[currentIndex];\r\n      setPreSong(current);\r\n      setSongReady(false);\r\n      changeCurrentDispatch(current);//赋值currentSong\r\n      audioRef.current.src = getSongUrl(current.id);\r\n      setTimeout(() => {\r\n        audioRef.current.play().then(() => {\r\n          setSongReady(true);\r\n        });\r\n      });\r\n      togglePlayingDispatch(true);//播放状态\r\n      setCurrentTime(0);//从头开始播放\r\n      setDuration((current.dt / 1000) | 0);//时长\r\n    }, [playList, currentIndex]);\r\n\r\n    const updateTime = e => {\r\n      setCurrentTime(e.target.currentTime);\r\n    }\r\n\r\n    const onProgressChange = curPercent => {\r\n      const newTime = curPercent * duration;\r\n      setCurrentTime(newTime);\r\n      audioRef.current.currentTime = newTime;\r\n      if (!playing) {\r\n        togglePlayingDispatch(true);\r\n      }\r\n    };\r\n  \r\n    // 一首歌循环\r\n    const handleLoop = () => {\r\n      audioRef.current.currentTime = 0;\r\n      changePlayingState(true);\r\n      audioRef.current.play();\r\n    }\r\n\r\n    // 播放上一首\r\n    const handlePrev = () => {\r\n      //播放列表只有一首歌的时单曲循环\r\n      if(playList.length === 1){\r\n        handleLoop();\r\n        return;\r\n      }\r\n      let index = currentIndex - 1;\r\n      if(index < 0) index = playList.length - 1;// 队尾变队头\r\n      if(!playing) togglePlayingDispatch(true);\r\n      changeCurrentIndexDispatch(index);\r\n    }\r\n\r\n    // 播放下一首\r\n    const handleNext = () => {\r\n      // 播放列表只有一首歌时单曲循环\r\n      if(playList.length === 1){\r\n        handleLoop();\r\n        return;\r\n      }\r\n      let index= currentIndex + 1;\r\n      if(index === playList.length) index = 0;\r\n      if(!playing) togglePlayingDispatch(true);\r\n      changeCurrentIndexDispatch(index);\r\n    }\r\n    return (\r\n        <div>\r\n        { isEmptyObject(currentSong) ? null : \r\n          <MiniPlayer\r\n            song={currentSong}\r\n            fullScreen={fullScreen}\r\n            playing={playing}\r\n            toggleFullScreen={toggleFullScreenDispatch}\r\n            clickPlaying={clickPlaying}\r\n            percent={percent}\r\n          /> \r\n        }\r\n        { isEmptyObject(currentSong) ? null : \r\n          <NormalPlayer\r\n            song={currentSong}\r\n            fullScreen={fullScreen}\r\n            playing={playing}\r\n            duration={duration} //总时长\r\n            currentTime={currentTime}//播放时长\r\n            percent={percent}//进度\r\n            toggleFullScreen={toggleFullScreenDispatch}\r\n            clickPlaying={clickPlaying}\r\n            onProgressChange={onProgressChange}\r\n            handlePrev={handlePrev}\r\n            handleNext={handleNext}\r\n          />\r\n        }\r\n        <audio \r\n          ref={audioRef}\r\n          onTimeUpdate={updateTime}\r\n        ></audio>\r\n      </div>\r\n    )\r\n}\r\n\r\n//映射 Redux 全局的 state 到组件的 props 上\r\nconst mapStateToProps = state => ({\r\n    fullScreen: state.getIn ([\"player\", \"fullScreen\"]),\r\n    playing: state.getIn ([\"player\", \"playing\"]),\r\n    currentSong: state.getIn ([\"player\", \"currentSong\"]),\r\n    showPlayList: state.getIn ([\"player\", \"showPlayList\"]),\r\n    mode: state.getIn ([\"player\", \"mode\"]),\r\n    currentIndex: state.getIn ([\"player\", \"currentIndex\"]),\r\n    playList: state.getIn ([\"player\", \"playList\"]),\r\n    sequencePlayList: state.getIn ([\"player\", \"sequencePlayList\"])\r\n})\r\n\r\n//映射 dispatch 到 props 上\r\nconst mapDispatchToProps = dispatch => {\r\n    return {\r\n      togglePlayingDispatch (data) {\r\n        dispatch (changePlayingState (data));\r\n      },\r\n      toggleFullScreenDispatch (data) {\r\n        dispatch (changeFullScreen (data));\r\n      },\r\n      togglePlayListDispatch (data) {\r\n        dispatch (changeShowPlayList (data));\r\n      },\r\n      changeCurrentIndexDispatch (index) {\r\n        dispatch (changeCurrentIndex (index));\r\n      },\r\n      changeCurrentDispatch (data) {\r\n        dispatch (changeCurrentSong (data));\r\n      },\r\n      changeModeDispatch (data) {\r\n        dispatch (changePlayMode (data));\r\n      },\r\n      changePlayListDispatch (data) {\r\n        dispatch (changePlayList (data));\r\n      }\r\n    };\r\n};\r\n\r\n// 将ui 组件 包装成容器组件\r\nexport default connect(\r\n    mapStateToProps,\r\n    mapDispatchToProps\r\n)(React.memo(Player));"]},"metadata":{},"sourceType":"module"}